yum install automake -y


emscripten 用的./emsdk activate 2.0.12

2.0.14不行

尝试 save state 和load state




save state
https://docs.mamedev.org/_files/MAME.pdf

里面的设置

tap 按钮调出设置

F7 是load state
left shift F7  是 save state


通过搜索按钮名字

grep -nR "Save State" *



save state的代码在
vim src/devices/machine/pdc.cpp

324 void pdc_device::device_start()
325 {
326     /* Resolve callbacks */
327     m_m68k_r_cb.resolve_safe(0);
328     m_m68k_w_cb.resolve_safe();
329
330     /* Save States */
331     save_item(NAME(reg_p0));
332     save_item(NAME(reg_p1));
333     save_item(NAME(reg_p2));
334     save_item(NAME(reg_p3));
335     save_item(NAME(reg_p4));
336     save_item(NAME(reg_p5));
337     save_item(NAME(reg_p6));
338     save_item(NAME(reg_p7));
339     save_item(NAME(reg_p21));
340     save_item(NAME(reg_p38));
341     save_item(NAME(fdd_68k_dma_address));
342 }

可能是这个，还有好几个，都得试验一下

思考：如何debug？
似乎加了-g4 也是wasm的debug，如何在浏览器里debug c？

每次加个代码，重新编译太慢了




思路：
这里 暴露到 js里，然后，传到indexdb进而传到server就可以了


cd mame
vim makefile
DEBUG=1


打印
osd_printf_verbose("\n");

osd_printf_info("haohao");

 vim src/frontend/mame/ui/state.cpp


3rdparty/genie/src/tools/gcc.lua

-g改成-g4

build/projects/sdl/mamepsikyo/gmake-asmjs/mame_psikyo.make

emmake make SUBTARGET=psikyo  SOURCES=src/mame/drivers/psikyo.cpp CXXFLAGS=-g4





待解决问题：
1.哪里能加-g4 ,如何debug
把src/emu下面都看看，有debug目录
2.Save State
3.怎么能编译得快一点，修改了mame，怎么能得到indexdb的变化？
4.怎么能保存game状态， shift+F7是保存 F7是load
是不是保存 indexdb就可以了 emularity/loader.js里
FS.mkdir('/emulator');
FS.mount(BFS, {root: '/'}, '/emulator');
5.c++ ，bazel编译，template使用



########1  如何debug
https://emscripten.org/docs/porting/Debugging.html
-g4 和-O3冲突，所以把O3都改成O0

参考sed -i  "s/\-pthread//g" `grep -rl "\-pthread" .`

sed -i  "s/ \-g / \-g4 --source-map-base http:\/\/121.5.59.140\/mame\/emularity\/ /g" `grep -rl " \-g " .`

sed -i  "s/ \-O3 / \-O0 /g" `grep -rl " \-O3 " .`

#emmake make SUBTARGET=psikyo  SOURCES=src/mame/drivers/psikyo.cpp CXXFLAGS="-g4 --source-map-base http://121.5.59.140/mame/emularity/ "
emmake make SUBTARGET=psikyo  SOURCES=src/mame/drivers/psikyo.cpp CXXFLAGS="-g4 --source-map-base http://121.5.59.140/mame/mame/ "


########2 Save State
src/frontend/mame/ui/state.cpp 
"Save State"
void menu_save_state::process_file
machine().schedule_save


src/emu/machine.cpp
void running_machine::schedule_save
set_saveload_filename



void running_machine::handle_saveload()
save_error saverr = (m_saveload_schedule == saveload_schedule::LOAD) ? m_save.read_file(file) : m_save.write_file(file);


grep -nR m_save *


src/emu/save.cpp
save_error save_manager::write_file(emu_file &file)
inline save_error save_manager::do_write


############4.



######
Compiling src/emu/debug/debugbuf.cpp...
Compiling src/emu/debug/debugcmd.cpp...
Compiling src/emu/debug/debugcon.cpp...
Compiling src/emu/debug/debugcpu.cpp...
Compiling src/emu/debug/debughlp.cpp...
Compiling src/emu/debug/debugvw.cpp...
Compiling src/emu/debug/dvbpoints.cpp...
Compiling src/emu/debug/dvdisasm.cpp...
Compiling src/emu/debug/dvmemory.cpp...
Compiling src/emu/debug/dvstate.cpp...
Compiling src/emu/debug/dvtext.cpp...
Compiling src/emu/debug/dvwpoints.cpp...
Compiling src/emu/debug/express.cpp...
Compiling src/emu/debug/points.cpp...
Compiling src/emu/debug/textbuf.cpp...
Compiling src/emu/debugger.cpp...


























